#!/bin/bash

declare -A max_sizes
declare -A max_timestamps

while true; do
    clear
    echo "=== /dev/shm Folder Size Monitor (Updated: $(date '+%Y-%m-%d %H:%M:%S')) ==="
    echo ""

    folders=$(find /dev/shm -mindepth 1 -maxdepth 1 2>/dev/null)

    empty_items=()

    if [ -z "$folders" ]; then
        echo "No folders or files in /dev/shm."
    else
        for folder in $folders; do
            # Get current size in kilobytes
            size_kb=$(du -sk "$folder" 2>/dev/null | awk '{print $1}')
            size_mb=$((size_kb / 1024))

            # Detect if empty
            if [ -f "$folder" ] && [ ! -s "$folder" ]; then
                empty_items+=("$folder")
            elif [ -d "$folder" ] && [ -z "$(ls -A "$folder" 2>/dev/null)" ]; then
                empty_items+=("$folder")
            fi

            # Update max size
            if [[ -z "${max_sizes[$folder]}" || "$size_kb" -gt "${max_sizes[$folder]}" ]]; then
                max_sizes[$folder]=$size_kb
                max_timestamps[$folder]=$(date '+%Y-%m-%d %H:%M:%S')
            fi

            max_mb=$((max_sizes[$folder] / 1024))
            echo "Item: $folder, Current Size: ${size_mb}MB, Peak: ${max_mb}MB at ${max_timestamps[$folder]}"
        done
    fi

    # Show empty files/folders
    if [ ${#empty_items[@]} -gt 0 ]; then
        echo ""
        echo "⚠️  Empty files/folders detected:"
        for item in "${empty_items[@]}"; do
            echo " - $item"
        done

        echo ""
        read -p "Do you want to delete these empty items? Type 'yes' to confirm: " confirm
        if [[ "$confirm" == "yes" ]]; then
            for item in "${empty_items[@]}"; do
                if rm -rf "$item" 2>/dev/null; then
                    echo "Deleted: $item"
                else
                    echo "❌ Failed to delete: $item"
                fi
            done
        else
            echo "No files were deleted."
        fi
        sleep 3
    fi

    sleep 1
done
